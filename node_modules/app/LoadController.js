class LoadController {
	constructor(model) {
		this._model = model;
	}
	load() {
		var model = this._model;
		return $.Deferred().resolve()
			.then(() => load("ЕГРП.csv", () => new ParticipantsRegistryReader(model)))
			.then(() => load("Собственники.csv", () => new OwnersRegistryReader(model)))
			.then(() => load("Квартиры без номера секции.csv", () => new ApartmentsWithoutSectionReader(model)))
			.then(() => load("Старые номера квартир.csv", () => new OldApartmentNumbersReader(model)));
	}
}

module.exports = LoadController;

var Loader = require("app/Loader");

function load(filename, readerFactory) {
	var loader = new Loader();
	return loader.load(filename)
		.then(function(csv) {
			try {
				var reader = readerFactory();
				var d = $.Deferred();
				reader.read(csv, function(ex) {
					ex ? d.reject(ex) : d.resolve();
				});
				return d;
			}
			catch (ex) {
				return $.Deferred().reject(ex);
			}
		});
}

var ParticipantsRegistryReader = require("app/model/readers/ParticipantsRegistryReader");
var OwnersRegistryReader = require("app/model/readers/OwnersRegistryReader");
var ApartmentsWithoutSectionReader = require("app/model/readers/ApartmentsWithoutSectionReader");
var OldApartmentNumbersReader = require("app/model/readers/OldApartmentNumbersReader");
