var View = require("app/views/View");

class DataSqlView extends View {
	constructor(sqlModel) {
		super();
		this._sqlModel = sqlModel;
	}
	getHtml() {
		return `
			<div class="DataSqlView" id="${this.uid}">
				<label>SQL-запрос (*)<br>
					<small>(*) Это интерфейс для продвинутых пользователей.  Предполагается, что Вы знакомы с языком SQL-запросов.</small><br>
					<textarea></textarea>
				</label><br>
				<button>Выполнить</button>
				<div id="${this.uid + "_messages"}"></div>
				<div id="${this.uid + "_results"}"></div>
			</div>
		`;
	}
	onInstalled() {
		super.onInstalled(...arguments);
		var me = this;

		this.$element().find("button").click(function() {
			var sql = me.$element().find("textarea").val();
			me._query(sql);
		});
	}
	_query(sql) {
		if (sql.trim().length == 0) {
			this._reportFailure("Введите запрос");
			return;
		}
		this._clearReport();
		this._clearResults();
		try {
			var res = this._sqlModel.query(sql);
		}
		catch (ex) {
			this._reportError(ex);
			return;
		}
		this._showResults(res);
	}
	_clearReport() {
		var $messages = this.$element().find("#" + this.uid + "_messages");
		$messages.empty();
	}
	_reportFailure(message) {
		var $messages = this.$element().find("#" + this.uid + "_messages");
		$messages.text(message);
	}
	_reportError(ex) {
		this._reportFailure(ex.message);
	}
	_clearResults() {
		var $results = this.$element().find("#" + this.uid + "_results");
		$results.empty();
	}
	_showResults(datasets) {
		var $results = this.$element().find("#" + this.uid + "_results");
		var acc = [];
		for (var i = 0, c = datasets.length; i < c; i++)
			renderDataset(datasets[i], acc);
		$results.html(acc.join(""));
	}
}

module.exports = DataSqlView;

var utils = require("app/utils");

function renderDataset(dataset, acc) {
	if (dataset.length == 0) {
		acc.push("<div class='DataSqlView_emptyResult>Нет результатов</div>");
		return;
	}
	acc.push("<table><thead><tr>");
	var header = dataset[0];
	for (var key in header)
		if (header.hasOwnProperty(key)) {
			acc.push("<th>");
			acc.push(utils.htmlEncode(key));
		}
	acc.push("</thead><tbody>");
	for (var i = 0, c = dataset.length; i < c; i++) {
		var row = dataset[i];
		acc.push("<tr>");
		for (var j = 0, cj = row.length; j < cj; j++) {
			acc.push("<td>");
			var value = row[j];
			if (value != null)
				acc.push(utils.htmlEncode(row[j].toString()));
		}
	}
	acc.push("</tbody></table>");
}
